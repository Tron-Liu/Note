# 第二章 IP协议详解

1. IP 头部信息：IP 头部信息出现在每个 IP 数据报中，用于指定 IP 通信的源端 IP 地址、目的端 IP 地址，指导 IP 分片和重组，以及指定部分通信行为
2. IP 数据报的路由和转发：

## 2.1 IP 服务的特点

IP 协议为上层协议提供无状态、无连接、不可靠的服务

1. 无状态（stateless）是指 IP 通信双方不同步传输数据的状态信息，因此所有 IP 数据报的发送、传输和接收都是相互独立、没有上下文关系的。这种服务最大的缺点是无法处理乱序和重复的 IP 数据报，优点则是简单、高效
2. 无连接（connectionless）是指 IP 通信双方都不长久地维持对方的任何信息。因此，上层协议每次发送数据的时候，都必须明确指定对方的 IP 地址
3. 不可靠是指 IP 协议不能保证 IP 数据报准确地到达接受端，它只是承诺尽最大努力（best effort）。无论哪种发送失败情况，发送端的 IP 模块一旦检测到 IP 数据报发送失败，就通知上层协议发送失败，而不会试图重传。因此，使用 IP 服务的上层协议需要自己实现数据确认、超时重传灯机制以达到可靠传输的目的

## 2.2 IPv4 头部结构

### 2.2.1 IPv4 头部结构

1. IPv4 的头部长度通常为20字节
   * 4 位版本号（version）
   * 4 位头部长度（header length）标识该 IP 头部有多少个32 bit字。因为4位最大能表示15，所以 IP 头部最长是 60 字节
   * 8 位服务类型（Type of Service，TOS）包括一个 3 位的优先权字段（已被忽略）、4 位的 TOS 字段和 1 位保留字段（必须置 0）。4 位 TOS 字段分别表示：最小延时，最大吞吐量，最高可靠性和最小费用
   * 16 位总长度（total length）是指整个 IP 数据报的长度，以字节为单位，因此 IP 数据报的最大长度为 65535 字节。但由于 MTU 的限制，长度超过 MTU 的数据报都将被分片传输，所以实际传输的 IP 数据报的长度都远没有达到最大值
   * 16 位标识（identification）唯一地标识主机发送的每一个数据报。其初始值由系统随机生成；每发送一个数据报，其值就加一。该值在数据报分片时被复制到每个分片中，因此同一个数据报的所有分片都具有相同的标识值
   * 3 位标志字段的第一位保留。第二位表示禁止分片。第三位表示更多分片，除了数据报的最后一个分片外，其他分片都要把它置 1
   * 13 位分片偏移（fragment offset）是分片相对于原始 IP 数据报开始处（仅指数据部分）的偏移。实际的偏移值是该值左移 3 位后得到的。由于这个原因，除了最后一个 IP 分片外，每个 IP 分片的数据部分的长度必须是 8 的整数倍
   * 8 位生存时间（Time To Live，TTL）是数据报到达目的地之前允许经过的路由器跳数。TTL 值被发送端设置（常见的值是64）。数据报在转发过程中每经过一个路由，该值就被路由器减一。当 TTL 值减为 0 时，路由器将丢弃数据报，并向源端发送一个 ICMP 差错报文。TTL 可以防止数据报陷入路由循环
   * 8 位协议（protocol）用来区分上层协议，其中 ICMP 是 1，TCP 是 6，UDP 是 17
   * 16 位头部校验和（header checksum）由发送端填充，接受端对其使用 CRC 算法以检验 IP 数据报头部在传输过程中是否损坏
   * 32 位源端 IP 和 32 位目的端 IP 地址用来标识数据报的发送端和接受端

## 2.3 IP 分片

1. 分片可能发生在发送端，也可能发生在中转路由器上，而且可能在传输过程中被多次分片，只有在最终的目标机器上，这些分片才会被内核中的 IP 模块重新组装
2. IP 头部中的“数据报标识”、“标志”和“片偏移”三个字段给 IP 的分片和重组提供了足够的信息。一个 IP 数据报的每个分片都具有自己的 IP 头部，它们具有相同的标识值，但具有不同的片偏移。并且除了最后一个分片外，其他分片都将设置 MF 标志。此外，每个分片的 IP 头部的总长度字段将被设置为该分片的长度

## 2.4 IP 路由

IP 路由：决定发送数据报到目标机器的路径

### 2.4.1 IP 模块工作流程

1. 当 IP 模块接收到来自数据数据链路层的 IP 数据报时，首先对该数据报的头部做CRC校验，确认无误后分析头部的具体信息
2. 如果该 IP 数据报的头部设置了源站选路选项（松散源路由选择或严格路由选择），则 IP 模块调用数据报转发子模块来处理该数据报。如果该 IP 数据报头部中的目标 IP 地址是本机的某个 IP 地址，或者是广播地址，即该数据报是发送给本机的，则 IP 模块就根据数据报头部中的协议字段来决定将它派发给哪个上层应用（分用）。如果 IP 模块发现这个数据报不是发送给本机的，则也调用数据报转发子模块来处理该数据报
3. 数据报转发子模块首先检测系统是否允许转发，如果不允许，IP 模块就将数据报丢弃。如果允许，数据报转发子模块将对数据报执行一些操作，然后将它交给 IP 数据报输出子模块
4. IP 数据报应该发送至哪一个下一跳路由（或者目标机器），以及经过哪个网卡来发送，就是 IP 路由过程。IP 模块实现数据报路由的核心数据结构是路由表。这个表按照数据报的目标 IP 地址分类，同一类型的 IP 数据报将被发往相同的下一跳路由器（或者目标机器
5. IP 输出队列中存放的是所有等待发送的 IP 数据报，其中除了需要转发的 IP 数据报外，还包括了封装本机上层数据的 IP 数据报

### 2.4.2 路由机制

1. 查找路由表中和数据报的目标 IP 地址完全匹配的主机 IP 地址。如果找到，就使用该路由项，没找到则转步骤 2
2. 查找路由表中和数据报的目标 IP 地址具有相同网路 ID 的网络 IP 地址。如果找到，就使用该路由项；没找到则转步骤 3
3. 选择默认路由项，这通常意味着数据报的下一跳路由是网关

## 2.5 IP 转发

对于允许 IP 数据报转发的主机或路由器，数据报转发子模块将对期望转发的数据报执行如下操作：

1. 检查数据报头部的 TTL 值。如果 TTL 值已经是 0，则丢弃该数据报
2. 查看数据报头部的严格源路由选择选项。如果该选项被设置，则检测数据报的目标 IP 地址是否是本机的某个 IP 地址。如果不是，则发送一个 ICMP 源站选路失败报文给发送端
3. 如果有必要，则给源端发送一个 ICMP 重定向报文，以告诉它一个更合理的下一跳路由器。
4. 将 TTL 值减 1
5. 处理 IP 头部选项
6. 如果有必要，则执行 IP 分片操作
