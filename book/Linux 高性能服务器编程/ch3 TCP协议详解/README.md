# 第三章 TCP协议详解

## 3.1 TCP 服务的特点

1. TCP 传输是可靠的
   * TCP 协议采用发送应答机制，即发送端发送的每个 TCP 报文段都必须得到接收方的应答，才认为这个 TCP 报文段传输成功
   * TCP 协议采用超时重传机制，发送端在发送出一个 TCP 报文段之后启动定时器，如果在定时时间内未收到应答，它将重新发送该报文段
   * 因为 TCP 报文段最终是以 IP 数据报发送的，而 IP 数据报到达接受端可能乱序、重复，所以 TCP 协议还会对接受到的 TCP 报文段重排、整理，再交付给应用层

## 3.2 TCP 头部结构

TCP 头部信息出现在每个 TCP 报文段中，用于指定通信的源端端口，目的端端口，管理 TCP 连接等

### 3.2.1 TCP 固定头部结构（20 字节）

1. 16 位源端端口号与 16 位目的端端口号（port number）：告知主机该报文段是来自哪里以及发送给哪个上层协议或应用程序的。进行 TCP 通信时，客户端通常使用系统自动选择的临时端口号，而服务器则使用知名服务端口号
2. 32 位序号（sequence number）：一次 TCP 通信（从 TCP 连接建立到断开）过程中某一个传输方向上的字节流的每个字节的编号。假设主机 A 和主机 B 进行 TCP 通信，A 发送给 B 的第一个 TCP 报文段中，序号值被系统初始化为某个随机值（ISN）。那么在该传输方向上（从 A 到 B），后续的 TCP 报文段中序号值将被系统设置成 ISN 加上该段报文所携带数据的第一个字节在整个字节流中的偏移
3. 32 位确认号（acknowledgement number）：用作对另一方发送来的 TCP 报文段的响应。其值是收到的 TCP 报文段的序号值加 1
4. 4 位头部长度：标识该 TCP 头部有多少个 32 bit 字，即 4 字节。因为 4 字节能最大表示 15，所以 TCP 头部最长为 `4 * 15 = 60` 字节
5. 6 位保留位
6. 6 位标志位
   * URG：表示紧急指针是否有效
   * ACK：表示确认号是否有效。称携带 ACK 标志的 TCP 报文段为确认报文段
   * PSH：提示接受端应用程序应该立即从 TCP 接受缓冲区中读走数据，为接受后续数据腾出空间。如果数据不被应用程序取走，则其将一直停留在接收缓冲区中
   * RST：表示要求对方重新建立连接。称携带 RST 标志的 TCP 报文段为复位报文段
   * SYN：表示请求建立一个连接。称携带 SYN 标志的 TCP 报文段为同步报文段
   * FIN：表示通知对方本端要关闭连接了。称携带 FIN 标志的 TCP 报文段为结束报文段
7. 16 位窗口大小（window size）：TCP 流量控制的一个手段。告诉对方本端的 TCP 接受缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度
8. 16 位校验和（TCP checksum）：由发送端填充，接受端对 TCP 报文段执行执行 CRC 算法已检验 TCP 报文段在传输过程中是否损坏
9. 16 位紧急指针（urgent pointer）：是一个正的偏移量。它和序号字段的值相加表示最后一个紧急数据的下一个字节的序号，即这个字段是紧急指针相对于当前序号的偏移

## 3.3 TCP 连接的建立和关闭

三次握手，四次挥手

### 3.3.2 半关闭状态

TCP 连接是全双工的，所以它允许两个方向的数据传输被独立关闭，即通信的一方可以发送结束报文段给对方，告诉对方本端已经完成了数据的发送，但允许继续接受来自对方的数据（仍需发送确认报文给对方），直到对方也发送结束报文段以关闭连接。TCP 连接的这种状态称为半关闭状态

### 3.3.3. 连接超时

如果因为网络原因，导致服务器对于客户端发出的同步报文段没有应答，此时客户端程序将进行 TCP 重连，如果重连仍然无效，则通知应用程序连接超时
